// texgen.js - http://github.com/mrdoob/texgen.js
'use strict';var TG={OP:{SET:function(a,b){return b},ADD:function(a,b){return a+b},SUB:function(a,b){return a-b},MUL:function(a,b){return a*b},DIV:function(a,b){return a/b},AND:function(a,b){return a&b},XOR:function(a,b){return a^b},MIN:function(a,b){return Math.min(a,b)},MAX:function(a,b){return Math.max(a,b)}},Texture:function(a,b){this.color=new Float32Array(4);this.buffer=new TG.Buffer(a,b);this.bufferCopy=new TG.Buffer(a,b)}};
TG.Texture.prototype={constructor:TG.Texture,set:function(a,b){void 0===b&&(b=TG.OP.SET);this.bufferCopy.copy(this.buffer);var c=a.getTint(),d=["var x = 0, y = 0;\nvar array = dst.array;\nvar width = dst.width, height = dst.height;\nfor ( var i = 0, il = array.length; i < il; i += 4 ) {","\t"+a.getSource(),"\tarray[ i     ] = operation( array[ i     ], color[ 0 ] * tint[ 0 ] );\n\tarray[ i + 1 ] = operation( array[ i + 1 ], color[ 1 ] * tint[ 1 ] );\n\tarray[ i + 2 ] = operation( array[ i + 2 ], color[ 2 ] * tint[ 2 ] );\n\tif ( ++x === width ) { x = 0; y ++; }\n}"].join("\n");
(new Function("operation, dst, src, color, tint",d))(b,this.buffer,this.bufferCopy,this.color,c);return this},add:function(a){return this.set(a,TG.OP.ADD)},sub:function(a){return this.set(a,TG.OP.SUB)},mul:function(a){return this.set(a,TG.OP.MUL)},div:function(a){return this.set(a,TG.OP.DIV)},and:function(a){return this.set(a,TG.OP.AND)},xor:function(a){return this.set(a,TG.OP.XOR)},min:function(a){return this.set(a,TG.OP.MIN)},max:function(a){return this.set(a,TG.OP.MAX)},toImageData:function(a){var b=
this.buffer,c=b.array;a=a.createImageData(b.width,b.height);for(var b=a.data,d=0,e=c.length;d<e;d+=4)b[d]=255*c[d],b[d+1]=255*c[d+1],b[d+2]=255*c[d+2],b[d+3]=255;return a},toCanvas:function(){var a=document.createElement("canvas");a.width=this.buffer.width;a.height=this.buffer.height;var b=a.getContext("2d"),c=this.toImageData(b);b.putImageData(c,0,0);return a}};
TG.Program=function(a){var b=new Float32Array([1,1,1]);a.tint=function(a,d,e){b[0]=a;b[1]=d;b[2]=e;return this};a.getTint=function(){return b};return a};TG.Number=function(){return new TG.Program({getSource:function(){return"color[ 0 ] = 1;\ncolor[ 1 ] = 1;\ncolor[ 2 ] = 1;"}})};TG.SinX=function(){var a=1,b=0;return new TG.Program({frequency:function(b){a=b*Math.PI;return this},offset:function(a){b=a;return this},getSource:function(){return["var value = Math.sin( ( x + "+b+" ) * "+a+" );","color[ 0 ] = value;\ncolor[ 1 ] = value;\ncolor[ 2 ] = value;"].join("\n")}})};
TG.SinY=function(){var a=1,b=0;return new TG.Program({frequency:function(b){a=b*Math.PI;return this},offset:function(a){b=a;return this},getSource:function(){return["var value = Math.sin( ( y + "+b+" ) * "+a+" );","color[ 0 ] = value;\ncolor[ 1 ] = value;\ncolor[ 2 ] = value;"].join("\n")}})};TG.OR=function(){return new TG.Program({getSource:function(){return"var value = ( x | y ) / width;\ncolor[ 0 ] = value;\ncolor[ 1 ] = value;\ncolor[ 2 ] = value;"}})};TG.XOR=function(){return new TG.Program({getSource:function(){return"var value = ( x ^ y ) / width;\ncolor[ 0 ] = value;\ncolor[ 1 ] = value;\ncolor[ 2 ] = value;"}})};
TG.Noise=function(){return new TG.Program({getSource:function(){return"var value = Math.random();\ncolor[ 0 ] = value;\ncolor[ 1 ] = value;\ncolor[ 2 ] = value;"}})};
TG.CheckerBoard=function(){var a=[32,32],b=[0,0],c=0;return new TG.Program({size:function(b,c){a=[b,c];return this},offset:function(a,c){b=[a,c];return this},rowShift:function(a){c=a;return this},getSource:function(){return["var value = ( ( ( y + "+b[1]+" ) / "+a[1]+" ) & 1 ) ^ ( ( ( x + "+b[0]+" + parseInt( y / "+a[1]+" ) * "+c+" ) / "+a[0]+" ) & 1 ) ? 0 : 1","color[ 0 ] = value;\ncolor[ 1 ] = value;\ncolor[ 2 ] = value;"].join("\n")}})};
TG.Rect=function(){var a=[0,0],b=[32,32];return new TG.Program({position:function(b,d){a=[b,d];return this},size:function(a,d){b=[a,d];return this},getSource:function(){return["var value = ( x >= "+a[0]+" && x <= "+(a[0]+b[0])+" && y <= "+(a[1]+b[1])+" && y >= "+a[1]+" ) ? 1 : 0;","color[ 0 ] = value;\ncolor[ 1 ] = value;\ncolor[ 2 ] = value;"].join("\n")}})};
TG.Circle=function(){var a=[0,0],b=50,c=1;return new TG.Program({delta:function(a){c=a;return this},position:function(b,c){a=[b,c];return this},radius:function(a){b=a;return this},getSource:function(){return["var dist = TG.Utils.distance( x, y, "+a[0]+","+a[1]+");","var value = 1 - TG.Utils.smoothStep( "+b+" - "+c+", "+b+", dist );","color[ 0 ] = value;\ncolor[ 1 ] = value;\ncolor[ 2 ] = value;"].join("\n")}})};
TG.SineDistort=function(){var a=[4,4],b=[0,0],c=[16,16];return new TG.Program({sines:function(b,c){a=[b,c];return this},offset:function(a,c){b=[a,c];return this},amplitude:function(a,b){c=[a,b];return this},getSource:function(){return["var s = Math.sin("+a[0]/100+" * y + "+b[0]+") * "+c[0]+" + x;","var t = Math.sin("+a[1]/100+" * x + "+b[1]+") * "+c[1]+" + y;","color.set( src.getPixelBilinear( s, t ) );"].join("\n")}})};
TG.Twirl=function(){var a=0,b=120,c=[128,128];return new TG.Program({strength:function(b){a=b/100;return this},radius:function(a){b=a;return this},position:function(a,b){c=[a,b];return this},getSource:function(){return["var dist = TG.Utils.distance( x, y, "+c[0]+","+c[1]+");","if (dist < "+b+") {","dist = Math.pow("+b+" - dist, 2) / "+b+";","var angle = 2.0 * Math.PI * (dist / ("+b+" / "+a+"));","s = (((x - "+c[0]+") * Math.cos(angle)) - ((y - "+c[0]+") * Math.sin(angle)) + "+c[0]+" + 0.5);","t = (((y - "+
c[1]+") * Math.cos(angle)) + ((x - "+c[1]+") * Math.sin(angle)) + "+c[1]+" + 0.5);","} else {\ns = x;\nt = y;\n}\ncolor.set( src.getPixelBilinear( s, t ) );"].join("\n")}})};
TG.Transform=function(){var a=[0,0],b=0,c=[1,1];return new TG.Program({offset:function(b,c){a=[b,c];return this},angle:function(a){b=TG.Utils.deg2rad(a);return this},scale:function(a,b){if(0!==a&&0!==b)return c=[a,b],this},getSource:function(){return["var x2 = x - width / 2;\nvar y2 = y - height / 2;","var s = x2 * ("+Math.cos(b)/c[0]+") + y2 * -("+Math.sin(b)/c[0]+");","var t = x2 * ("+Math.sin(b)/c[1]+") + y2 * (\t"+Math.cos(b)/c[1]+");","s += "+a[0]+" + width /2;","t += "+a[1]+" + height /2;",
"color.set( src.getPixelBilinear( s, t ) );"].join("\n")}})};TG.Pixelate=function(){var a=[1,1];return new TG.Program({size:function(b,c){a=[b,c];return this},getSource:function(){return["var s = "+a[0]+" * Math.floor(x/"+a[0]+");","var t = "+a[1]+" * Math.floor(y/"+a[1]+");","color.set( src.getPixelNearest( s, t ) );"].join("\n")}})};TG.Buffer=function(a,b){this.width=a;this.height=b;this.array=new Float32Array(a*b*4);this.color=new Float32Array(4)};
TG.Buffer.prototype={constructor:TG.Buffer,copy:function(a){this.array.set(a.array)},getPixelNearest:function(a,b){b>=this.height&&(b-=this.height);0>b&&(b+=this.height);a>=this.width&&(a-=this.width);0>a&&(a+=this.width);var c=this.array,d=this.color,e=Math.round(b)*this.width*4+4*Math.round(a);d[0]=c[e];d[1]=c[e+1];d[2]=c[e+2];return this.color},getPixelBilinear:function(a,b){var c=Math.floor(a),d=Math.floor(b),e=c+d*this.width,f=this.array,p=this.color,m=a-c,g=b-d,n=1-m,c=1-g,d=n*c,c=m*c,n=n*g,
m=m*g,g=4*e,k=4*(1+e),l=4*(1*this.width+e),e=4*(1+1*this.width+e),h=this.width*this.height*4;g>=h&&(g-=h);0>g&&(g+=h);k>=h&&(k-=h);0>k&&(k+=h);l>=h&&(l-=h);0>l&&(l+=h);e>=h&&(e-=h);0>e&&(e+=h);p[0]=f[g+0]*d+f[k+0]*c+f[l+0]*n+f[e+0]*m;p[1]=f[g+1]*d+f[k+1]*c+f[l+1]*n+f[e+1]*m;p[2]=f[g+2]*d+f[k+2]*c+f[l+2]*n+f[e+2]*m;p[3]=f[g+3]*d+f[k+3]*c+f[l+3]*n+f[e+3]*m;return this.color},getPixelOffset:function(a){var b=this.array,c=this.color;a=parseInt(4*a);c[0]=b[a];c[1]=b[a+1];c[2]=b[a+2];c[3]=b[a+3];return this.color}};
TG.Utils={smoothStep:function(a,b,c){c=TG.Utils.clamp((c-a)/(b-a),0,1);return c*c*(3-2*c)},distance:function(a,b,c,d){a=c-a;b=d-b;return Math.sqrt(a*a+b*b)},clamp:function(a,b,c){return Math.min(Math.max(a,b),c)},deg2rad:function(a){return a*Math.PI/180}};
